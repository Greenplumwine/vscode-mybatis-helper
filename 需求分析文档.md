# MyBatis Helper 插件需求分析文档

## 1. 项目概述

MyBatis Helper 是一款专为 MyBatis 开发者设计的 VSCode 插件，旨在提升 MyBatis 项目的开发效率。该插件通过提供控制台日志拦截、SQL 转换以及文件快速跳转等功能，帮助开发者更便捷地进行 MyBatis 应用的开发和调试。插件采用直接启动机制，确保在 VSCode 启动完成后自动激活，无需依赖命令触发。

## 2. 功能需求分析

### 2.1 控制台日志拦截与 SQL 转换

#### 2.1.1 功能描述

该功能实时拦截 IDE 控制台中的 MyBatis 日志，自动解析参数化查询，并将其转换为可直接复制执行的完整 SQL 语句。

#### 2.1.2 详细需求

- **日志拦截**：实时监控并捕获控制台输出的 MyBatis 日志信息
- **日志格式配置**：支持用户自定义日志格式配置，以适应不同的日志输出模式
- **SQL 解析**：准确识别和解析 MyBatis 参数化查询语句
- **参数填充**：将参数值正确填充到 SQL 语句中，生成完整的可执行 SQL
- **多数据库支持**：支持 MySQL、PostgreSQL、Oracle、SQL Server、达梦、人大金仓等多种数据库的 SQL 语法
- **信息提取**：提取并显示 SQL 执行时间、参数类型和值等关键信息
- **输出展示**：在独立的 "MyBatis SQL" 输出通道中展示格式化、高亮的 SQL 语句
- **历史记录**：自动保存 SQL 历史记录，方便回溯查询
- **清空功能**：提供一键清空 SQL 历史记录的功能

### 2.2 文件快速跳转

#### 2.2.1 功能描述

实现 Mapper 接口与 XML 文件之间的一键双向跳转，简化文件查找过程，并支持精确定位到对应的具体方法。

#### 2.2.2 详细需求

- **双向跳转**：支持从 Mapper 接口跳转到 XML 文件，也支持从 XML 文件跳转到 Mapper 接口
- **智能映射**：自动扫描项目结构，建立 Mapper 接口与 XML 文件的映射关系
- **项目结构支持**：支持标准 Maven/Gradle 项目结构及自定义项目布局，并提供配置选项让用户指定自定义项目结构的规则
- **大型项目优化**：针对大型复杂项目优化映射算法，确保快速定位目标文件
- **按需激活**：插件在打开工作区后，检测到存在 Java 项目时才开始执行映射关系处理逻辑，避免在非 Java 项目中不必要的资源消耗
- **全限定类名搜索**：支持通过全限定类名搜索对应的 Mapper 接口和 XML 文件
- **缓存刷新**：自动刷新映射缓存，确保文件位置变更时仍能正确跳转
- **缓存优先级策略**：实现明确的缓存检查优先级机制，在执行文件跳转时优先检查缓存，仅在缓存未命中时才执行文件查找逻辑
- **特定文件查找优化**：将全文件夹扫描优化为针对特定文件的精确查找，显著提高跳转效率
- **缓存存储逻辑**：新增文件查找结果的缓存存储机制，确保后续相同文件的跳转能够直接使用缓存结果
- **条件性提示显示**：实现智能的提示信息显示逻辑，仅在执行文件查找时显示"正在查找文件"的提示，使用缓存时不显示任何额外提示，提供更流畅的用户体验
- **CodeLens 支持**：为文件跳转功能提供 CodeLens 交互方式，在 Java 文件的方法上方和 XML 文件的 SQL 语句上方显示跳转提示，用户可通过点击直接进行跳转操作
- **精确方法跳转**：支持在跳转时精确定位到对应的具体方法，而不仅仅是打开文件，提升用户操作效率
- **重构跳转逻辑**：采用独立的导航器模式（JavaToXmlNavigator和XmlToJavaNavigator），提高代码可维护性
- **优先使用Java插件API**：优先使用Red Hat Java插件提供的API进行精确导航，提升跳转准确性

### 2.3 用户界面

#### 2.3.1 功能描述

提供用户友好的界面交互，使插件功能易于使用。

#### 2.3.2 详细需求

- **命令菜单**：提供简洁明了的命令菜单，所有功能一目了然
- **快捷键体系**：设计高效的快捷键体系，提升操作便捷性
- **右键菜单集成**：深度集成编辑器右键菜单，方便快速访问功能
- **状态反馈**：提供实时状态反馈，使操作结果即时可见
- **用户体验**：符合 VSCode 设计规范，无缝融入开发环境

## 3. 非功能需求

### 3.1 性能需求

- 插件应具有极高的性能表现，确保在大型项目中也能快速响应
- 所有耗时操作必须在后台线程执行，严禁阻塞 VSCode 主线程
- 首次加载和扫描时应采用异步方式，最大程度减少对用户操作的影响
- 内存使用应保持在合理范围内，避免影响 VSCode 整体性能
- 对于文件扫描和解析等计算密集型任务，应采用分片处理或增量处理策略
- Java 项目检测应在后台异步执行，避免影响工作区打开速度
- **具体性能指标**：
  - 插件启动时间不超过 2 秒
  - 大型项目（1000+ 文件）扫描时间不超过 10 秒
  - 单次 SQL 转换处理时间不超过 100 毫秒
  - 内存占用峰值不超过 100MB

### 3.2 兼容性需求

- 插件需要兼容 VSCode 1.100.3 或更高版本
- 应支持多种操作系统（Windows、macOS、Linux）
- 需要兼容多种主流数据库的 SQL 语法
- **兼容性规格**：
  - VSCode 版本：1.100.3 及以上
  - 操作系统：Windows 10/11, macOS 10.14+, Ubuntu 18.04+
  - 数据库支持：MySQL 5.7+, PostgreSQL 10+, Oracle 12c+, SQL Server 2016+

### 3.3 可用性需求

- 界面设计应简洁直观，易于理解和使用
- 提供详细的使用指南和文档
- 错误提示应清晰明确，帮助用户快速定位问题

### 3.4 可维护性需求

- 代码结构应清晰，便于后续维护和功能扩展
- 遵循 VSCode 插件开发规范
- 提供完善的日志记录，便于问题排查
- **模块化设计**：采用模块化设计，将跳转逻辑封装到独立的导航器类中，提高代码可维护性和执行效率

### 3.5 安全性需求

- 插件不应收集或传输用户的任何敏感信息
- 所有文件操作应遵循最小权限原则
- 插件应防止路径遍历等安全漏洞
- 对用户输入进行适当验证，防止注入攻击

### 3.6 配置管理需求

- 提供直观的配置界面，方便用户进行个性化设置
- 支持配置文件的导入和导出
- 配置变更应实时生效，无需重启插件
- 提供配置重置功能，方便用户恢复默认设置
- **国际化支持**：插件应支持多语言界面，能够根据 VSCode 的语言设置自动切换显示语言，并提供配置选项允许用户自定义界面语言
- **CodeLens 配置**：提供配置选项允许用户启用或禁用 CodeLens 功能，默认启用

## 4. 技术需求

### 4.1 开发技术栈

- **语言**：TypeScript
- **框架**：VSCode Extension API
- **构建工具**：TypeScript Compiler (tsc)
- **包管理**：pnpm
- **测试框架**：Mocha
- **国际化框架**：vscode-l10n

### 4.2 性能优化技术方案

为了满足高性能要求，避免阻塞主线程，我们将采用混合优化方案，结合多种技术的优势，既保证查找准确性，又确保性能表现：

1. **优先集成 VSCode Java 扩展 API**：作为首选的文件查找手段，充分利用其准确性和性能优势
2. **优化缓存机制**：实现多层级缓存策略，根据数据类型和访问模式设置不同的缓存过期时间，并添加 LRU 缓存淘汰策略
3. **改进文件扫描策略**：实现增量扫描算法和并行扫描，只扫描变化的文件和相关依赖，大幅提高扫描效率
4. **索引机制**：为 Mapper 接口和 XML 文件创建索引，使用高效的数据结构存储映射关系，实现 O(1) 时间复杂度的映射查找
5. **条件性降级机制**：在 Java 扩展不可用或查找失败时，降级使用传统查找方式作为备选方案
6. **重构跳转逻辑**：采用模块化设计，将跳转逻辑封装到独立的导航器类中，提高代码可维护性和执行效率
7. **优先使用Java插件API**：优先使用Red Hat Java插件提供的API进行精确导航，减少文件扫描和正则表达式匹配的开销

**详细实现方案**：

### 4.2.1 优先集成 VSCode Java 扩展 API

通过集成 VSCode 的 Java 扩展 API，可以直接获取项目的结构信息，避免手动扫描文件，大幅提升性能。Java 扩展 API 将作为首选的文件查找手段，充分利用其准确性和性能优势。只有在 Java 扩展不可用或查找失败时，才会降级使用传统查找方式作为备选方案，以确保在各种环境下插件仍能正常工作。

**使用策略**：
- **优先使用**：在 Java 扩展可用时，优先使用其 API 进行文件查找，充分利用其准确性和性能优势
- **条件性降级**：当 Java 扩展不可用或查找失败时，自动降级到传统查找方式作为备选方案
- **缓存结合**：将 Java 扩展 API 的查找结果与缓存机制结合，进一步提升性能

### 4.2.2 优化缓存机制

实现多层级缓存策略，根据数据类型和访问模式设置不同的缓存过期时间，并添加 LRU 缓存淘汰策略。缓存机制是性能优化的核心组件之一，移除缓存会导致频繁的文件系统操作和 API 调用，严重影响性能。我们将保留并进一步优化缓存机制。

**优化策略**：
- **多层级缓存**：根据数据访问频率和重要性设置不同层级的缓存
- **智能 TTL**：根据数据类型设置合理的过期时间
- **LRU 淘汰**：确保热点数据常驻缓存，冷数据及时清理
- **缓存预热**：在插件启动时预加载常用数据到缓存
- **缓存与 Java API 结合**：将 Java 扩展 API 的查找结果缓存，避免重复调用

### 4.2.3 改进文件扫描策略

实现增量扫描算法和并行扫描，只扫描变化的文件和相关依赖，大幅提高扫描效率。通过增量扫描，我们避免了对未修改文件的重复处理；通过并行扫描，我们充分利用多核 CPU 的计算能力，进一步提升扫描速度。

**扫描优化策略**：
- **增量扫描**：只扫描修改过的文件，避免重复处理
- **并行处理**：利用多核 CPU 并行处理文件，提高扫描速度
- **批处理调度**：将文件分批处理，避免阻塞主线程
- **智能队列管理**：根据文件优先级和依赖关系安排扫描顺序

### 4.2.4 索引机制

为 Mapper 接口和 XML 文件创建索引，使用高效的数据结构存储映射关系。通过建立类名与 XML 路径的双向映射关系，我们可以将原本需要遍历大量文件的查找操作优化为 O(1) 时间复杂度，极大提升查找性能。

**索引机制优化策略**：
- **O(1) 时间复杂度**：通过建立类名与 XML 路径的双向映射关系，实现常数时间复杂度的查找
- **持久化存储**：将索引数据持久化到磁盘，避免每次启动插件时重新构建索引
- **增量更新**：当文件发生变化时，只更新相关索引项，避免全量重建
- **内存优化**：合理设计索引数据结构，减少内存占用
- **防抖保存**：通过防抖机制减少索引保存频率，提高性能

### 4.2.5 实施细节

- 异步编程模型将应用于所有文件读取、网络请求和计算密集型操作
- 增量处理将通过监听文件变化事件实现，仅处理变更部分
- 事件驱动架构将基于 VSCode 的事件系统构建
- 工作区监听将通过监听工作区文件变化实现，检测到 pom.xml、build.gradle 等 Java 项目标识文件时激活插件功能
- 插件激活后将异步初始化映射关系处理逻辑，避免阻塞主线程
- 精确文件查找：通过针对特定文件的精确查找替代全文件夹扫描，减少不必要的文件读取和遍历操作
- 智能提示控制：通过条件性控制提示信息的显示，避免在缓存命中场景下的不必要的界面交互，提升用户体验
- **重构跳转逻辑**：采用模块化设计，将跳转逻辑封装到独立的导航器类中，提高代码可维护性和执行效率
- **优先使用Java插件API**：优先使用Red Hat Java插件提供的API进行精确导航，减少文件扫描和正则表达式匹配的开销

### 4.3 依赖分析

- `@types/vscode`: VSCode API 类型定义
- `@types/node`: Node.js 类型定义
- `typescript`: TypeScript 编译器
- `@vscode/test-electron`: VSCode 测试框架

## 5. 用户交互设计

### 5.1 命令设计

- `MyBatis: 切换日志拦截`：启用或禁用日志拦截功能
- `MyBatis: 显示 SQL 输出`：打开 MyBatis SQL 输出通道
- `MyBatis: 清空 SQL 历史`：清空已保存的 SQL 历史记录
- `MyBatis: 跳转到 XML`：从 Mapper 接口跳转到对应的 XML 文件
- `MyBatis: 跳转到 Mapper`：从 XML 文件跳转到对应的 Mapper 接口
- `MyBatis: 刷新映射关系`：重新扫描项目结构，更新文件映射关系
- `MyBatis: 配置插件`：打开插件配置界面，包括语言设置等选项

### 5.2 快捷键设计

- `Alt+L`：切换日志拦截状态
- `Alt+X`：从 Mapper 接口跳转到 XML 文件
- `Alt+M`：从 XML 文件跳转到 Mapper 接口

### 5.3 菜单集成

- 在 Java 文件的右键菜单中添加 "MyBatis: 跳转到 XML" 选项
- 在 XML 文件的右键菜单中添加 "MyBatis: 跳转到 Mapper" 选项

### 5.4 CodeLens 交互

- **Java 文件中的 CodeLens**：在 Java Mapper 接口的方法上方显示"跳转到 XML"的 CodeLens 提示
- **XML 文件中的 CodeLens**：在 XML 映射文件的 SQL 语句上方显示"跳转到 Mapper"的 CodeLens 提示
- **智能显示控制**：CodeLens 仅在检测到有效映射关系时显示，避免显示无效的跳转提示
- **点击直接跳转**：用户点击 CodeLens 提示可直接执行跳转操作，无需使用快捷键或右键菜单

## 6. 部署与安装

### 6.1 安装方式

- 通过 VSCode 扩展市场安装
- 支持手动安装 VSIX 文件

### 6.2 发布要求

- 遵循 VSCode 扩展发布规范
- 提供完整的插件描述和图标
- 包含详细的 README 文档和使用指南

## 7. 测试需求

### 7.1 功能测试

- 验证日志拦截与 SQL 转换功能的准确性
- 测试不同数据库类型的 SQL 解析正确性
- 验证文件跳转功能在各种项目结构下的可靠性
- 测试快捷键和菜单项的功能正确性
- **国际化测试**：验证插件在不同语言环境下的显示正确性，包括界面文本翻译准确性和布局适应性
- **按需激活测试**：验证插件在打开包含 Java 项目的工作区时能正确激活，在非 Java 项目工作区中不激活

### 7.2 性能测试

- 在大型项目中测试插件的响应速度，确保界面无卡顿
- 验证插件在长时间运行下的稳定性
- 测试高负载情况下的内存使用情况，确保无内存泄漏
- 验证所有耗时操作均在后台执行，不会阻塞 VSCode 主线程
- 测试文件扫描和解析功能的性能，确保在大型项目中也能快速完成
- 验证增量处理和缓存机制的有效性
- 验证 Java 扩展 API 集成的性能优势
- 测试索引机制对文件查找速度的提升效果
- 验证条件性降级机制的有效性
- **重构跳转逻辑测试**：验证模块化跳转逻辑的正确性和性能表现
- **Java插件API优先级测试**：验证优先使用Java插件API的功能是否正常工作

**测试方法和工具**：

- 使用 VSCode Extension Test Framework 进行自动化性能测试
- 利用 Chrome DevTools 监控内存使用情况和检测内存泄漏
- 通过模拟大型项目（1000+ 文件）测试插件性能
- 使用性能分析工具（如 clinic.js）分析插件性能瓶颈
- 在不同操作系统上进行性能测试，确保跨平台性能一致性
- 对比优化前后的性能指标，验证优化效果

### 7.3 兼容性测试

- 在不同操作系统上验证插件功能
- 在不同版本的 VSCode 中测试兼容性

## 8. 未来扩展性

### 8.1 功能扩展

- 支持更多数据库类型的 SQL 语法
- 增加 SQL 性能分析功能
- 提供代码生成辅助功能

### 8.2 技术扩展

- 支持更多项目构建工具（如 Gradle Kotlin DSL）
- 集成更多 VSCode API 功能

## 9. 性能优化预期效果

通过实施上述性能优化方案，预计将实现以下效果：

1. 在大型项目中，文件映射和跳转速度提升 50%-80%
2. 首次加载和扫描时间减少 40%-60%
3. 内存占用降低 30%-50%
4. 提供更流畅、更稳定的用户体验
5. 增强插件在复杂项目结构下的适应性

这些优化将使 MyBatis Helper 插件在处理大型和复杂的 MyBatis 项目时表现更加出色，为开发者提供更高效、更流畅的开发体验。

## 10. 混合方案优势总结

本混合性能优化方案结合了多种技术的优势，既保证了查找准确性，又确保了性能表现：

1. **准确性与性能并重**：优先集成 VSCode Java 扩展 API 提高查找准确性，同时保留优化的缓存机制和索引机制确保性能
2. **环境适应性强**：在有 Java 扩展的环境中优先使用 API 提升准确性，在无 Java 扩展的环境中条件性降级到传统机制保证基本功能
3. **渐进式优化**：通过增量扫描、并行处理和智能缓存等策略，实现渐进式性能提升
4. **容错能力高**：条件性降级机制确保在任何环境下都能提供基本功能
5. **可维护性好**：模块化设计使各组件职责清晰，便于后续维护和扩展
6. **重构跳转逻辑**：采用模块化设计，将跳转逻辑封装到独立的导航器类中，提高代码可维护性和执行效率
7. **优先使用Java插件API**：优先使用Red Hat Java插件提供的API进行精确导航，减少文件扫描和正则表达式匹配的开销

## 11. 风险评估

### 11.1 技术风险

- 日志格式识别的准确性可能受自定义日志配置影响
- 在非常大的项目中，首次扫描和建立映射关系可能耗时较长
- 插件可能与某些 VSCode 主题或扩展产生兼容性问题
- 复杂的项目结构可能导致映射关系建立不准确
- Java 项目检测可能误判，导致在非 Java 项目中错误激活插件或在 Java 项目中未能正确激活
- 按需激活机制可能增加插件初始化的复杂性，影响启动时间
- 性能优化方案实施过程中可能引入新的问题
- Java 扩展 API 的版本兼容性问题可能影响功能稳定性
- 缓存机制设计不当可能导致内存占用过高
- 索引机制实现复杂，可能影响插件的稳定性和可维护性
- **Java插件依赖**：插件依赖于Red Hat Java扩展以提供最佳性能，如果该扩展不可用，插件将降级使用文件扫描和正则表达式匹配

### 11.2 应对措施

- 提供日志格式配置选项，增强插件适应性
- 优化扫描算法，提供进度反馈，提升用户体验
- 在不同 VSCode 主题和常用扩展环境下进行充分测试
- 提供手动映射配置功能，允许用户自定义映射关系
- 建立完善的错误处理机制，确保插件在遇到异常时能够优雅降级
- 优化 Java 项目检测算法，提高检测准确性
- 提供手动激活/停用插件的功能，允许用户手动控制插件状态
- 对按需激活机制进行充分测试，确保在各种场景下都能正确工作
- 采用渐进式优化策略，分阶段实施性能优化方案
- 添加版本检测和兼容层，确保与不同版本的 Java 扩展兼容
- 实现智能缓存大小控制和自动清理机制
- 采用模块化设计，确保索引机制的可维护性和可扩展性
- **Java插件依赖处理**：实现条件性降级机制，确保在Java插件不可用时仍能提供基本功能